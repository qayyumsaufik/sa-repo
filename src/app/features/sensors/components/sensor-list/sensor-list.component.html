<div class="sensor-list">
  <p-card>
    <ng-template pTemplate="header">
      <div class="card-header">
        <div>
          <h2>Sensors</h2>
          <p class="subtitle">Manage sensors within devices</p>
        </div>
        @if (canManageSensors()) {
          <p-button 
            label="Create Sensor" 
            icon="pi pi-plus" 
            (onClick)="showCreateForm()"
            class="ml-auto">
          </p-button>
        }
      </div>
    </ng-template>

    <app-error-message [onDismiss]="clearError" />
    <app-loading-spinner />

    @if (!loadingService.loading()) {
      <p-table [value]="sensors()" dataKey="id" [rowTrackBy]="trackBySensorId" [paginator]="true" [rows]="10" [first]="tableFirst()"
               [showCurrentPageReport]="true" [lazy]="true" (onLazyLoad)="onLazyLoad($event)" [totalRecords]="totalRecords()"
               [sortField]="sortField()" [sortOrder]="sortOrder()"
               currentPageReportTemplate="Showing {first} to {last} of {totalRecords} entries"
               [rowsPerPageOptions]="[10, 25, 50]">
        <ng-template pTemplate="header">
          <tr>
            <th [pSortableColumn]="'name'">Name <p-sortIcon [field]="'name'" /></th>
            <th>Address</th>
            <th>Threshold</th>
            <th>Clear Threshold</th>
            <th [pSortableColumn]="'deviceName'">Device <p-sortIcon [field]="'deviceName'" /></th>
            <th [pSortableColumn]="'regTypeName'">RegType <p-sortIcon [field]="'regTypeName'" /></th>
            @if (canManageSensors()) {
              <th>Actions</th>
            }
          </tr>
          <tr class="filter-row">
            <th>
              <input type="text" pInputText [(ngModel)]="filterName" (input)="onFilterChange()" placeholder="Filter name" class="filter-input" />
            </th>
            <th></th>
            <th></th>
            <th></th>
            <th>
              <p-dropdown
                [options]="deviceFilterOptions()"
                [(ngModel)]="deviceFilterValue"
                (onChange)="onFilterChange()"
                optionLabel="label"
                optionValue="value"
                placeholder="All devices"
                [showClear]="true"
                class="filter-dropdown-inline">
              </p-dropdown>
            </th>
            <th></th>
            @if (canManageSensors()) {
              <th></th>
            }
          </tr>
        </ng-template>
        <ng-template pTemplate="body" let-sensor>
          <tr>
            <td>{{ sensor.name }}</td>
            <td>{{ sensor.address || '-' }}</td>
            <td>{{ sensor.threshold || '-' }}</td>
            <td>{{ sensor.clearThreshold || '-' }}</td>
            <td>{{ sensor.deviceName }}</td>
            <td>{{ sensor.regTypeName }}</td>
            @if (canManageSensors()) {
              <td>
                <p-button 
                  icon="pi pi-pencil" 
                  [text]="true" 
                  [rounded]="true"
                  severity="info"
                  (onClick)="editSensor(sensor)"
                  pTooltip="Edit"
                  tooltipPosition="top">
                </p-button>
                <p-button 
                  icon="pi pi-trash" 
                  [text]="true" 
                  [rounded]="true"
                  severity="danger"
                  (onClick)="deleteSensor(sensor.id)"
                  pTooltip="Delete"
                  tooltipPosition="top">
                </p-button>
              </td>
            }
          </tr>
        </ng-template>
      </p-table>
    }
    @if (!loadingService.loading() && sensors().length === 0) {
      <div class="empty-state">
        <i class="pi pi-inbox" style="font-size: 3rem; color: #999;"></i>
        <p>No sensors found. Create your first sensor!</p>
      </div>
    }
  </p-card>

  <app-modal
    [isOpen]="showModal()"
    [title]="editingSensor() ? 'Edit Sensor' : 'Create Sensor'"
    (close)="closeModal()">
    <form (ngSubmit)="saveSensor()">
      <div class="p-field">
        <label for="name">Name *</label>
        <input 
          id="name"
          type="text" 
          pInputText 
          [(ngModel)]="formData.name" 
          name="name" 
          required 
          class="full-width" />
      </div>

      <div class="p-field">
        <label for="address">Address</label>
        <input 
          id="address"
          type="text" 
          pInputText 
          [(ngModel)]="formData.address" 
          name="address"
          class="full-width" />
      </div>

      <div class="p-field">
        <label for="threshold">Threshold</label>
        <input 
          id="threshold"
          type="number" 
          step="any" 
          pInputText 
          [(ngModel)]="formData.threshold" 
          name="threshold"
          class="full-width" />
        <small class="p-text-secondary">Value at which site status becomes Red</small>
      </div>

      <div class="p-field">
        <label for="clearThreshold">Clear Threshold</label>
        <input 
          id="clearThreshold"
          type="number" 
          step="any" 
          pInputText 
          [(ngModel)]="formData.clearThreshold" 
          name="clearThreshold"
          class="full-width" />
        <small class="p-text-secondary">Value below which threshold is cleared (must be less than Threshold). Between Clear Threshold and Threshold = Yellow status.</small>
      </div>

      <div class="p-field">
        <label for="deviceId">Device *</label>
        <p-dropdown 
          id="deviceId"
          [options]="deviceOptions()" 
          [(ngModel)]="formData.deviceId" 
          name="deviceId"
          optionLabel="label" 
          optionValue="value"
          placeholder="Select Device"
          [showClear]="true"
          class="full-width"
          required>
        </p-dropdown>
      </div>

      <div class="p-field">
        <label for="regTypeId">RegType *</label>
        <p-dropdown 
          id="regTypeId"
          [options]="regTypeOptions()" 
          [(ngModel)]="formData.regTypeId" 
          name="regTypeId"
          optionLabel="label" 
          optionValue="value"
          placeholder="Select RegType"
          [showClear]="true"
          class="full-width"
          required>
        </p-dropdown>
      </div>

      <div class="form-actions">
        <p-button 
          label="Cancel" 
          [text]="true"
          (onClick)="closeModal()" 
          type="button">
        </p-button>
        <p-button 
          label="Save" 
          type="submit"
          [style]="{'margin-left': '0.5rem'}">
        </p-button>
      </div>
    </form>
  </app-modal>
</div>
