<div class="site-detail">
  <div class="site-detail-header">
    <p-button 
      icon="pi pi-arrow-left" 
      [text]="true"
      [rounded]="true"
      (onClick)="goBack()"
      pTooltip="Back to Dashboard"
      tooltipPosition="right">
    </p-button>
    <div class="header-content">
      <h1>{{ selectedSite()?.name || 'Site Details' }}</h1>
      <p-tag [value]="getSiteStatus()" [severity]="getStatusSeverity(getSiteStatus())"></p-tag>
    </div>
  </div>

  <!-- View Tabs -->
  <p-tabView [(activeIndex)]="currentView" (onChange)="setView($event)">
    <p-tabPanel header="Engineering View">
      <div class="engineering-view">
        <!-- Site Selector and Time Range -->
        <div class="view-controls">
          <p-dropdown 
            [options]="siteOptions()"
            [(ngModel)]="siteId"
            (onChange)="onSiteChange($event)"
            placeholder="Select Site"
            optionLabel="label"
            optionValue="value"
            class="w-300">
          </p-dropdown>

          <p-dropdown 
            [options]="timeRangeOptions"
            [(ngModel)]="timeRange"
            (onChange)="onTimeRangeSelect($event)"
            placeholder="Time Range"
            optionLabel="label"
            optionValue="value"
            class="w-200">
          </p-dropdown>
        </div>

        <!-- Charts Grid -->
        <div class="charts-grid">
          <!-- Level Chart -->
          <p-card class="chart-card">
              <ng-template pTemplate="header">
                <div class="card-header chart-header">
                  <h3>Level</h3>
                  <div class="chart-controls">
                    <p-tag [value]="getCurrentLevelValue()" severity="info"></p-tag>
                    <p-multiSelect 
                      [options]="levelSensorOptions()"
                      [(ngModel)]="selectedLevelSensors"
                      (onChange)="onLevelSensorsSelect($event)"
                      placeholder="Sensors"
                      optionLabel="label"
                      optionValue="value"
                      class="w-200-ml-1">
                    </p-multiSelect>
                  </div>
                </div>
              </ng-template>
              <app-level-chart [data]="filteredLevelChartData()" />
            </p-card>

          <!-- AMPS Chart -->
          <p-card class="chart-card">
              <ng-template pTemplate="header">
                <div class="card-header chart-header">
                  <h3>AMPS</h3>
                  <div class="chart-controls">
                    <p-tag [value]="getCurrentAmpsValue()" severity="info"></p-tag>
                    <p-multiSelect 
                      [options]="ampsSensorOptions()"
                      [(ngModel)]="selectedAmpsSensors"
                      (onChange)="onAmpsSensorsSelect($event)"
                      placeholder="Sensors"
                      optionLabel="label"
                      optionValue="value"
                      class="w-200-ml-1">
                    </p-multiSelect>
                  </div>
                </div>
              </ng-template>
              <app-amps-chart [data]="filteredAmpsChartData()" />
            </p-card>

          <!-- State Transition Chart -->
          <p-card class="chart-card">
              <ng-template pTemplate="header">
                <div class="card-header chart-header">
                  <h3>State Transition</h3>
                  <p-dropdown 
                    [options]="stateVariableOptions"
                    [(ngModel)]="selectedStateVariable"
                    placeholder="Variable"
                    optionLabel="label"
                    optionValue="value"
                    class="w-200-ml-1">
                  </p-dropdown>
                </div>
              </ng-template>
              <app-state-transition-chart [data]="stateTransitions()" />
            </p-card>

          <!-- Events Chart -->
          <p-card class="chart-card">
              <ng-template pTemplate="header">
                <div class="card-header chart-header">
                  <h3>Events</h3>
                </div>
              </ng-template>
              <app-events-chart [data]="eventsChartData()" />
            </p-card>
        </div>

        <!-- Maintenance Log -->
        <p-card class="maintenance-log-card">
          <ng-template pTemplate="header">
            <div class="card-header">
              <h3>Maintenance Log</h3>
              <p-button 
                label="View Maintenance" 
                icon="pi pi-wrench"
                [routerLink]="['/maintenance']" 
                [queryParams]="{siteId: siteId()}">
              </p-button>
            </div>
          </ng-template>
          <p>View and manage maintenance logs for this site on the Maintenance page.</p>
        </p-card>
      </div>
    </p-tabPanel>

    <p-tabPanel header="Operator View">
      <div class="operator-view">
        <!-- Simplified controls for Operator View -->
        <div class="view-controls">
          <p-dropdown 
            [options]="siteOptions()"
            [(ngModel)]="siteId"
            (onChange)="onSiteChange($event)"
            placeholder="Select Site"
            optionLabel="label"
            optionValue="value"
            class="w-300">
          </p-dropdown>

          <p-dropdown 
            [options]="timeRangeOptions"
            [(ngModel)]="timeRange"
            (onChange)="onTimeRangeSelect($event)"
            placeholder="Time Range"
            optionLabel="label"
            optionValue="value"
            class="w-200">
          </p-dropdown>
        </div>

        <!-- Simplified charts for Operator View -->
        <div class="charts-grid">
          <p-card class="chart-card">
              <ng-template pTemplate="header">
                <div class="card-header chart-header">
                  <h3>Level</h3>
                  <p-tag [value]="getCurrentLevelValue()" severity="info"></p-tag>
                </div>
              </ng-template>
              <app-level-chart [data]="filteredLevelChartData()" />
            </p-card>

          <p-card class="chart-card">
              <ng-template pTemplate="header">
                <div class="card-header chart-header">
                  <h3>AMPS</h3>
                  <p-tag [value]="getCurrentAmpsValue()" severity="info"></p-tag>
                </div>
              </ng-template>
              <app-amps-chart [data]="filteredAmpsChartData()" />
            </p-card>
        </div>
      </div>
    </p-tabPanel>
  </p-tabView>

  <app-error-message [onDismiss]="clearError" />
  <app-loading-spinner />
</div>
